<!DOCTYPE html>
<html lang="ko">
<head>
  <!-- Use correct character set. -->
  <meta charset="utf-8">
  <!-- Tell IE to use the latest, best version. -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <title>GangWon Open-Pit Mine Monitoring System</title>
  <link href="lib/jquery-ui.css" rel="stylesheet" type="text/css" />
  <link href="lib/thumbnail-slider.css" rel="stylesheet" type="text/css" />
  <link href="cesium_1.24/Build/Cesium/Widgets/widgets.css" rel="stylesheet" type="text/css" />
  <style>
  html, body {width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; }
  #header {height: 80px; width:100%; color:#FFF; text-align:center; background-color:#0a0b2f; }
  #header h1 {font-family:"Arial"; text-shadow: 0.1em 0.1em 0.15em #DDD; padding-top:10px; margin:0;}
  #header h4 {font-family:"맑은 고딕"; text-shadow: 0.1em 0.1em 0.15em #DDD; margin:0;}
  
  #wrap {width:100%; min-width:1000px; min-height:500px; overflow:hidden; }
  #leftContainer {width:50%; height:100%; position:relative; float:left; background-color:#0F0; }
  #rightContainer {width:50%; height:100%; position:relative; float:left; background-color:#00F; }
  
  #leftCesium {width:100%; height:100%; position:absolute; background-color:#FF0; }
  #rightCesium {width:100%; height:100%; position:absolute; background-color:#F0F; }
  
  .uiBox {
    position:absolute; 
    top:10px; left:10px; width:380px; height:120px;
    background-color: #333; border-radius: 7px;
    box-shadow: 2px 2px 3px #888;
    padding: 2px 10px 0 15px;
  }
  .uiBox h2 {
    height:15px; width:100%;
    margin:0 0 8px 0; padding:0 0 7px 0;
    border-bottom:1px solid #999;
    font-family:"맑은 고딕"; font-size:1.0em; color: #ea4;
    opacity:1.0;
  }
  .uiBox button {border-radius: 4px; font-family:"맑은 고딕"; font-size: 13px;}
  .ui-slider-handle {
    width:30px !important; height:15px !important; line-height:1.6em !important;
    top:50% !important; margin-top:-8px !important; margin-left:-15px !important;
    text-align:center !important; font-size:10px !important; 
  }
  .ui-slider-horizontal {height:2px; }
  .sliderText {
    position:relative; width:50px; height: 50px; float:left;
    font-family:"맑은 고딕"; font-size: 12px; text-shadow: 0 0 0.2em #FFF, 0 0 0.2em #FFF, 0 0 0.2em #FFF;
  }
  .sliderBox {
    position:relative; left:15px; width:300px; height: 10px; float:left; vertical-align:middle;
  }
  .photoYears {position:relative;}
  .yearSlider {position:absolute; top:58px; left:70px; width:300px;}
  .buttonBox {width: 380px;}
  
  </style>

  <script src="lib/jquery-1.12.3.min.js" type="text/javascript"></script>
	<script src="lib/jquery-ui.js" type="text/javascript"></script>
  <script src="lib/thumbnail-slider.js" type="text/javascript"></script>
  <script src="./cesium_1.24/Build/Cesium/Cesium.js" type="text/javascript"></script>
  <script src="./cesium_1.24/Build/Cesium/GeoserverTerrainProvider.js" type="text/javascript"></script>
	<script src="info/site_info.js" type="text/javascript"></script>
  <script>
  // On Init
  $( function(){
    initDivSize();
    /*
    initUiBox(
      {
        photoYearArray:[2007,2008,2010,2013,2014,2015,2016], 
        demYearArray:[2007,2014,2015,2016]
      }
    );
    */
    initMenuSlider();
    initCesium();
    setDefaultDataset();
    
    // 초기 위치 지정
    viewer.camera.flyTo({
      destination : Cesium.Cartesian3.fromDegrees(128.48, 37.31, 180000)
    });

     // 지형 추가
     initTerrains();
     
     // WMS Layer 추가
     initWmsLayers();
  });
  
  // 브라우저 크기 조정시 div 크기 재조정
  $(window).resize(initDivSize);
  
  // set divs size
  function initDivSize() {
    var fullHeight = $(document).height();
    var fullWidth = $(document).width();
    var mapWidth = Math.floor(fullWidth / 2);
    var mapHeight = fullHeight - $("#header").height();
    
    $("#wrap").height(mapHeight);
    $("#leftContainer").width(mapWidth);
    $("#rightContainer").width(mapWidth);
  }
  
  function initMenuSlider() {
    // http://www.menucool.com/jquery-slider
    var thumbnailSliderOptions =
    {
      sliderId: "thumbnail-slider",
      orientation: "horizontal",
      thumbWidth: "120px",
      thumbHeight: "80px",
      showMode: 1,
      autoAdvance: false,
      selectable: false,
      slideInterval: 3000,
      transitionSpeed: 0,
      shuffle: false,
      startSlideIndex: 0, //0-based
      pauseOnHover: true,
      initSliderByCallingInitFunc: false,
      rightGap: 0,
      keyboardNav: true,
      mousewheelNav: false,
      before: null,
      license: "mylicense"
    };

    var mcThumbnailSlider = new ThumbnailSlider(thumbnailSliderOptions);
    $("#thumbnail-slider ul li").on("click", function() {
      var selected = $(this);
      $("#thumbnail-slider ul li").each(function() {
        $(this).removeClass("active");
      });
      selected.addClass("active");
      crrSite = selected.attr('data').trim();
      var crrSiteInfo = siteInfo[crrSite];
      if (!crrSiteInfo) 
        hideInfo();
      else
        showInfo(crrSiteInfo);		
    });
    
    //////////////
    // jQuery Tooltip
    $( "#thumbnail-slider" ).tooltip();
  }
  
  function showInfo(option) {
    if (!option) 
      return;
      
    $(".uiBox").hide();
    
    $("#leftContainer .uiBox h2").text(option.title);

    var photoYearArray = option.photoYearArray;
    var demYearArray = option.demYearArray;
    
    if (!photoYearArray || !demYearArray)
      return;
    if (!photoYearArray.indexOf || !demYearArray.indexOf)
      return;
    if (!photoYearArray.length || !demYearArray.length)
      return;
    if (photoYearArray.length == 1) {
      photoYearArray.push(photoYearArray[0]);
    }
    if (demYearArray.length == 1) {
      demYearArray.push(demYearArray[0]);
    }
    
    var minYear = Math.min(Math.min.apply(Math, photoYearArray), Math.min.apply(Math, demYearArray));
    var maxYear = Math.max(Math.max.apply(Math, photoYearArray), Math.max.apply(Math, demYearArray));
    
    var fullYears = photoYearArray;
    $.each(demYearArray, function(i, el){
      if ($.inArray(el, fullYears) === -1) fullYears.push(el);
    });
    fullYears = fullYears.sort();
    var secondIndex = fullYears.length - 2;
    if (secondIndex < 0) secondIndex = 0;
    var secondYear = fullYears[secondIndex];
    
    var leftHandle = $("#leftContainer .ui-slider-handle");
    $("#leftContainer .yearSlider").slider({
      min: minYear,
      max: maxYear,
      value: maxYear,
      step: 1,
      create: function() {
        leftHandle.text($(this).slider("value"));
      },
      slide: function(event, ui) {
        leftHandle.text(ui.value);
      }
    });
    
    // UI Box 복사
    $("#rightContainer .uiBox").html($("#leftContainer .uiBox").html());
    
    var rightHandle = $("#rightContainer .ui-slider-handle");
    $("#rightContainer .yearSlider").slider({
      min: minYear,
      max: maxYear,
      value: secondYear,
      step: 1,
      create: function() {
        rightHandle.text($(this).slider("value"));
      },
      slide: function(event, ui) {
        rightHandle.text(ui.value);
      }
    });

    // UI BOX 보이기
    $("#leftContainer .uiBox").show("drop", {}, 500);
    $("#rightContainer .uiBox").show("drop", {}, 500);
        
    // 연도별 눈끔 그리기
    var canvasList = document.getElementsByTagName("canvas");
    for (var i=0; canvasList.length; i++) {
      var canvas = canvasList[i];
      if (canvas == null) return;
      
      var ctx = canvas.getContext("2d");
      if (!ctx)
        continue;
        
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle="yellow";
      ctx.strokeStyle="yellow";
      ctx.font='11px "맑은 고딕"';
      ctx.fillText("영상년도:", 0,12, 40);
      ctx.fillText("DEM년도:", 0,51, 40);
      ctx.font='8px "맑은 고딕"';
      
      ctx.fillStyle="#FFF";
      ctx.strokeStyle="#FFF";
      var delta = 300.0/(maxYear-minYear);
      
      var y = 10;
      for (var year=minYear, x=45; year<=maxYear; year++, x += delta) {
        if (photoYearArray.indexOf(year) >= 0) {
          ctx.beginPath();
          ctx.fillText(year, x,y, 30);
          ctx.moveTo(x+11,y+5);
          ctx.lineTo(x+11,y+15);
          ctx.stroke();
        }
      }

      y = 50;
      for (var year=minYear, x=45; year<=maxYear; year++, x += delta) {
        if (demYearArray.indexOf(year) >= 0) {
          ctx.beginPath();
          ctx.fillText(year, x,y, 30);
          ctx.moveTo(x+11,y-10);
          ctx.lineTo(x+11,y-25);
          ctx.stroke();
        }
      }
    }

		if (infoObj.view)
			viewer.camera.flyTo(infoObj.view);
  }

	function hideInfo() {
		$(".uiBox").hide();
	}

  var viewer, slaveViewer;
  function initCesium() {
    // 불필요한 타임라인 없에고 초기화, 레이어 선택은 남김
    viewer = new Cesium.Viewer('leftCesium', {timeline : false, animation : false});
    slaveViewer = new Cesium.Viewer('rightCesium', {timeline : false, animation : false});
    
    // Sync master & slave
    var masterCamera = viewer.scene.camera;
    var slaveCamera = slaveViewer.scene.camera;

    slaveViewer.scene.preRender.addEventListener(function(){
      if(slaveViewer.scene.mode !== Cesium.SceneMode.MORPHING){
        slaveCamera.setView({
          destination : masterCamera.position,
          orientation: {
            heading : masterCamera.heading,
            pitch : masterCamera.pitch,
            roll :  masterCamera.roll
          }
        });
      }
    });
  }

  function setDefaultDataset() {
    var DEFALUT_IMAGE = "ESRI World Imagery";
    var DEFALUT_TERRAIN = "STK World Terrain meshes";
    
    // LEFT VIEW
    // 기본으로 설정할 이미지를 baseLayerPicker에서 찾아
    var imageryProvider = null;
    for (i in viewer.baseLayerPicker.viewModel.imageryProviderViewModels) {
      provider = viewer.baseLayerPicker.viewModel.imageryProviderViewModels[i];
      if (provider.name == DEFALUT_IMAGE) {
        imageryProvider = provider;
        break;
      }
    }
    if (imageryProvider) viewer.baseLayerPicker.viewModel.selectedImagery = imageryProvider;
    
    // 기본으로 설정할 지형을 baseLayerPicker에서 찾아
    var terrainProvider = null;
    for (i in viewer.baseLayerPicker.viewModel.terrainProviderViewModels) {
      provider = viewer.baseLayerPicker.viewModel.terrainProviderViewModels[i];
      if (provider.name == DEFALUT_TERRAIN) {
        terrainProvider = provider;
        break;
      }
    }
    if (terrainProvider) viewer.baseLayerPicker.viewModel.selectedTerrain = terrainProvider;

    // RIGHT VIEW
    // 기본으로 설정할 이미지를 baseLayerPicker에서 찾아
    var imageryProvider = null;
    for (i in slaveViewer.baseLayerPicker.viewModel.imageryProviderViewModels) {
      provider = slaveViewer.baseLayerPicker.viewModel.imageryProviderViewModels[i];
      if (provider.name == DEFALUT_IMAGE) {
        imageryProvider = provider;
        break;
      }
    }
    if (imageryProvider) slaveViewer.baseLayerPicker.viewModel.selectedImagery = imageryProvider;
    
    // 기본으로 설정할 지형을 baseLayerPicker에서 찾아
    var terrainProvider = null;
    for (i in slaveViewer.baseLayerPicker.viewModel.terrainProviderViewModels) {
      provider = slaveViewer.baseLayerPicker.viewModel.terrainProviderViewModels[i];
      if (provider.name == DEFALUT_TERRAIN) {
        terrainProvider = provider;
        break;
      }
    }
    if (terrainProvider) slaveViewer.baseLayerPicker.viewModel.selectedTerrain = terrainProvider;
  }

  var demProvider;
  function initTerrains(option) {
    demProvider = {};
    demProvider["dem_2007"] = new Cesium.GeoserverTerrainProvider({
      url : "/geoserver/gwc/service/wms",
      layerName: "dem_2007",
      styleName:"demToColor",
      maxLevel: 17,
      formatImage : {format : "image/png", extension: "png"}
    });
    demProvider["dem_2014"] = new Cesium.GeoserverTerrainProvider({
      url : "/geoserver/gwc/service/wms",
      layerName: "dem_2014",
      styleName:"demToColor",
      maxLevel: 17,
      formatImage : {format : "image/png", extension: "png"}
    });
    demProvider["dem_2015"] = new Cesium.GeoserverTerrainProvider({
      url : "/geoserver/gwc/service/wms",
      layerName: "dem_2015",
      styleName:"demToColor",
      maxLevel: 17,
      formatImage : {format : "image/png", extension: "png"}
    });
    demProvider["dem_2016"] = new Cesium.GeoserverTerrainProvider({
      url : "/geoserver/gwc/service/wms",
      layerName: "dem_2016",
      styleName:"demToColor",
      maxLevel: 17,
      formatImage : {format : "image/png", extension: "png"}
    });
  }

  var crrDemName = "";
  function setDem(demName) {
    if (demName == undefined) {
      console.error("Unknown DEM Selected!");
      return;
    }
    if (crrDemName) {
      if (crrDemName != demName) {
        viewer.terrainProvider = demProvider[demName];
        crrDemName = demName;
      }
    } else {
      viewer.terrainProvider = demProvider[demName];
      crrDemName = demName;
    }
  }

	var imgProvider = {};
	function initWmsLayers() {
    addWmsLayer("lafarge","photo",2014, 'Sangji:2013_WGS84');
    addWmsLayer("lafarge","photo",2015, 'Sangji:2015_UAV_wgs84');
    addWmsLayer("lafarge","photo",2016, 'Sangji:2016_merge_WGS84');
    addWmsLayer("lafarge","restore",2016, 'Sangji:restore_2016_2015');
    addWmsLayer("lafarge","restore",2015, 'Sangji:restore_2015_2014');
    addWmsLayer("lafarge","dig",2015, 'Sangji:dig_2015_2014');
    addWmsLayer("lafarge","dem_delta",2016, 'Sangji:DemDelta_2016-2015_5187');
    addWmsLayer("lafarge","dem_delta",2015, 'Sangji:DemDelta_2015-2007_5187');
    addWmsLayer("lafarge","photo_delta",2016, 'Sangji:PhotoDeltaDelta_2016-2015');
    addWmsLayer("lafarge","photo_delta",2015, 'Sangji:PhotoDeltaDelta_2015-2014');
    
    var crrYear = 2016;
    var crrSite = "lafarge";
    var crrPhoto = "photo";
    var crrTheme = null;
	}
  
	function addWmsLayer(site, theme, year, wmsLayer) {
		var id = site+":"+theme+":"+year;
		
		imgProvider[id] = new Cesium.WebMapServiceImageryProvider({
			url : '/geoserver/gwc/service/wms',
			layers : wmsLayer,
			parameters : {
				transparent : 'true',
				format : 'image/png'
			}
		});
	}
	
	function setWmsLayer(option) {
		var year = option.year ? option.year : crrYear;
		var site = option.site ? option.site : crrSite;
		
		crrYear = year;
		crrSite = site;
		
		var photo = option.photo ? option.photo : crrPhoto;
		var theme = option.theme ? option.theme : crrTheme;
		
		var photoId = site+":"+photo+":"+year;
		var themeId = site+":"+theme+":"+year;
		
		var photoProvider = imgProvider[photoId];
		var themeProvider = imgProvider[themeId];
		

		while (viewer.scene.imageryLayers.get(1))
			viewer.scene.imageryLayers.remove(viewer.scene.imageryLayers.get(1));

		if (photoProvider) {
			viewer.scene.imageryLayers.addImageryProvider(photoProvider);
			crrPhoto = photo;
		}
		
		if (themeProvider) {
			viewer.scene.imageryLayers.addImageryProvider(themeProvider);
			crrTheme = theme;
		}
	}

  </script>
</header>
<body>
  <div id="header">
    <h1>GangWon Open-Pit Mine Monitoring System</h1>
    <h4> - 상지대학교 지형정보연구실 - </h4>
  </div>
  
  <div id="wrap">
    <div id="leftContainer">
      <div id="leftCesium"></div>
      <div class="uiBox" style="display:none;">
        <h2>라파즈 한라시멘트 - 가행광산</h2>
        <canvas class="photoYears" width="370" height="55"></canvas >
        <div class="yearSlider">
          <div class="ui-slider-handle"></div>
        </div>
        <div class="buttonBox">
          <button>영상보기</button>
          <button>영상변화분석</button>
          <button>지형변화분석</button>
          <button>변화지역보기</button>
        </div>
      </div>
    </div>
    
    <div id="rightContainer">
      <div id="rightCesium"></div>
      <div class="uiBox" style="display:none;">
      </div>
    </div>
    
    <div id="thumbnail-slider">
      <div class="inner">
        <ul>
          <li title="라파즈 한라시멘트" data="lafarge">
            <a class="thumb" href="thumb/Lafarge_1.png"></a>
          </li>
          <li title="동양시멘트" data="dongyang">
            <a class="thumb" href="thumb/Dongyang_1.png"></a>
          </li>
          <li title="아시아시멘트"  data="asia">
            <a class="thumb" href="thumb/Asia_1.png"></a>
          </li>
          <li title="현대시멘트"  data="hyundai">
            <a class="thumb" href="thumb/Hyundai_1.png"></a>
          </li>
          <li title="쌍용시멘트"  data="ssangyoung">
            <a class="thumb" href="thumb/SSangyoung_1.png"></a>
          </li>
          <li class="speacer"></li>
          <li title="상지대학교"  data="sangji">
            <a class="thumb" href="thumb/Sangji_1.PNG"></a>
          </li>
          <li title="광해지역"  data="forest_damage">
            <a class="thumb" href="thumb/ForestDamage_1.PNG"></a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</body>